(()=>{"use strict";var e={d:(r,n)=>{for(var t in n)e.o(n,t)&&!e.o(r,t)&&Object.defineProperty(r,t,{enumerable:!0,get:n[t]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},r={};e.r(r),e.d(r,{clearCache:()=>_,syncIndividual:()=>w,useSync:()=>E});const n=require("tslib"),t=require("react"),o=require("react-redux");var c,a,i=[],u=new Map;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR"}(c||(c={}));var s,f=function(e){if(a&&a.throwError)throw new Error(e);console.error(e)},d={DEBUG:"color: #5bc0de",INFO:"color: #28a745",WARN:"color: #ffc107",ERROR:"color: #dc3545",DEFAULT:""},l=function(e,r,n){if(void 0===r&&(r="INFO"),(null==a?void 0:a.log)&&function(e){if(!(null==a?void 0:a.logLevel))return!0;var r=c[a.logLevel];return c[e]>=r}(r)){var t=(new Date).toISOString(),o="[".concat(t,"] %c").concat(r.toUpperCase(),"%c: ").concat(e);if(a.logger)return a.logger(o);n?console[r.toLowerCase()](o,d[r],d.DEFAULT,n):console[r.toLowerCase()](o,d[r],d.DEFAULT)}},v=new Map,g=new Map,h=new Map,y=5e3,_=function(e){e?v.delete(e):v.clear()},E=function(e){var r=e.fetchOrder,c=e.fetchItems,d=e.throwError,E=void 0===d||d,p=e.cacheDuration,R=e.logLevel,k=void 0===R?"DEBUG":R,O=(0,n.__rest)(e,["fetchOrder","fetchItems","throwError","cacheDuration","logLevel"]),m=((0,t.useRef)(!0),(0,t.useRef)(!1)),b=(0,t.useRef)((0,n.__assign)({fetchOrder:r,fetchItems:c,throwError:E,logLevel:k},O));console.log("----------------------\x3e SYNCING"),y=p||y,a=b.current,u=b.current.fetchItems,i=b.current.fetchOrder;var S=(0,n.__read)((0,t.useState)({isPending:!0,haveError:!1}),2),D=S[0],U=S[1],I=(0,n.__read)((0,t.useState)(new Set),2),A=I[0],L=I[1];(0,t.useEffect)((function(){U((function(e){return(0,n.__assign)((0,n.__assign)({},e),{isPending:A.size>0})}))}),[A]);var B=(0,t.useRef)([]),G=(0,o.useDispatch)();s=G;var F=(0,t.useCallback)((function(e){return(0,n.__awaiter)(void 0,void 0,void 0,(function(){return(0,n.__generator)(this,(function(r){switch(r.label){case 0:return[4,w(e,G)];case 1:return r.sent(),[2]}}))}))}),[G]),N=(0,t.useCallback)((function(e,r){return(0,n.__awaiter)(void 0,void 0,void 0,(function(){var t,o,c,a,i;return(0,n.__generator)(this,(function(u){L((function(r){return new Set((0,n.__spreadArray)((0,n.__spreadArray)([],(0,n.__read)(r),!1),[e.key],!1))}));try{return t="".concat(e.key,"-").concat(r),o=Date.now(),(c=v.get(t))&&o<c.expiresAt?(l("Using cached data for ".concat(e.key),"DEBUG"),[2,c.data]):(a=g.get(t))&&o-a.timestamp<5e3?(l("Reusing pending request for ".concat(e.key),"DEBUG"),[2,a.promise]):(i=(0,n.__awaiter)(void 0,void 0,void 0,(function(){var c,a;return(0,n.__generator)(this,(function(n){switch(n.label){case 0:return n.trys.push([0,,3,4]),l("Making fresh request for ".concat(e.key),"DEBUG"),[4,fetch(r,e.options||{})];case 1:if(!(c=n.sent()).ok)throw l("Request failed for ".concat(e.key),"ERROR",{status:c.status}),new Error("Failed to fetch ".concat(e.key));return[4,c.json()];case 2:return a=n.sent(),v.set(t,{data:a,timestamp:o,expiresAt:o+y}),l("Cached new data for ".concat(e.key),"DEBUG",{expiresAt:new Date(o+y)}),[2,a];case 3:return g.delete(t),[7];case 4:return[2]}}))})),g.set(t,{timestamp:o,promise:i}),[2,i])}finally{L((function(r){var n=new Set(r);return n.delete(e.key),n}))}return[2]}))}))}),[]),C=(0,t.useCallback)((function(){return(0,n.__awaiter)(void 0,void 0,void 0,(function(){var e,r,t,o,c,a,i,u,s,d,v,g,y,_,E,p,w;return(0,n.__generator)(this,(function(R){switch(R.label){case 0:if(!m.current)return[2];R.label=1;case 1:return R.trys.push([1,3,4,5]),U({isPending:!0,haveError:!1}),l("Starting sync process","INFO"),e=[],r=[],t=[],o=b.current.fetchOrder,c=b.current.fetchItems,o.forEach((function(n){n.refetchOnline&&e.push(n.key),n.refetchOnFocus&&r.push(n.key),n.triggerEvents&&t.push({events:"string"==typeof n.triggerEvents?[n.triggerEvents]:n.triggerEvents,key:n.key})})),a=function(){l("Online event triggered","DEBUG"),e.forEach((function(e){return F(e)}))},i=function(){l("Focus event triggered","DEBUG"),r.forEach((function(e){return F(e)}))},window.addEventListener("online",a),window.addEventListener("focus",i),u=new Map,t.forEach((function(e){var r=e.key;e.events.forEach((function(e){var n=function(){l('Window event "'.concat(e,'" triggered for ').concat(r),"DEBUG"),F(r)};u.set("".concat(r,"-").concat(e),n),"undefined"!=typeof window&&window.addEventListener(e,n)}))})),s=o.map((function(e){return(0,n.__awaiter)(void 0,void 0,void 0,(function(){var r,t;return(0,n.__generator)(this,(function(o){switch(o.label){case 0:if("boolean"==typeof e.initialSync&&!e.initialSync)return[2];if("boolean"==typeof e.backgroundSync&&e.backgroundSync)return[2,h.set(e.key,(function(){return F(e.key)}))];if(B.current.includes(e.key))return l("Skipping ".concat(e.key," - already pending"),"WARN"),[2];if(!(r=c.get(e.key)))return l("URL not found for ".concat(e.key),"ERROR"),[2,f("url not found for ".concat(e.key))];B.current=(0,n.__spreadArray)((0,n.__spreadArray)([],(0,n.__read)(B.current),!1),[e.key],!1),o.label=1;case 1:return o.trys.push([1,,3,4]),[4,N(e,r)];case 2:return t=o.sent(),m.current&&G(e.action(t)),[3,4];case 3:return m.current&&(B.current=B.current.filter((function(r){return r!==e.key}))),[7];case 4:return[2]}}))}))})).filter(Boolean),[4,Promise.all(s)];case 2:return R.sent(),m.current&&U({isPending:!1,haveError:!1}),[2,function(){l("Cleaning up event listeners","DEBUG"),window.removeEventListener("online",a),window.removeEventListener("focus",i),t.forEach((function(e){var r=e.key;e.events.forEach((function(e){var n=u.get("".concat(r,"-").concat(e));n&&"undefined"!=typeof window&&window.removeEventListener(e,n)}))})),u.clear()}];case 3:return d=R.sent(),U((function(e){return(0,n.__assign)((0,n.__assign)({},e),{haveError:!0})})),l("Sync process failed","ERROR",{error:d}),b.current.onError&&b.current.onError(d),[3,5];case 4:v=Array.from(h.entries());try{for(g=(0,n.__values)(v),y=g.next();!y.done;y=g.next())_=(0,n.__read)(y.value,2),E=_[0],(0,_[1])(),h.delete(E)}catch(e){p={error:e}}finally{try{y&&!y.done&&(w=g.return)&&w.call(g)}finally{if(p)throw p.error}}return[7];case 5:return[2]}}))}))}),[G,N,F]);return(0,t.useEffect)((function(){m.current=!0;var e=C();return function(){m.current=!1,e.then((function(e){return e&&e()}))}}),[C]),{isPending:D.isPending||A.size>0,haveError:D.haveError,clearCache:_,refresh:C,loadingItems:Array.from(A)}},p=[],w=function(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];return(0,n.__awaiter)(void 0,(0,n.__spreadArray)([e],(0,n.__read)(r),!1),void 0,(function(e,r){var t,o,c,a,d;return void 0===r&&(r=s),(0,n.__generator)(this,(function(n){switch(n.label){case 0:if(t="individual-".concat(e),g.get(t))return l("Request already pending for ".concat(e),"DEBUG"),[2];if(p.includes(e))return l("Skipping duplicate fetch for ".concat(e),"DEBUG"),[2];l("Starting individual sync for ".concat(e),"INFO"),p.push(e),n.label=1;case 1:return n.trys.push([1,,4,5]),o=i.find((function(r){return r.key===e})),(c=u.get(e))&&o?[4,fetch(c,o.options||{})]:(l("Configuration not found for ".concat(e),"ERROR"),[2,f("no url found for item ".concat(e))]);case 2:if(!(a=n.sent()).ok)throw l("Individual sync failed for ".concat(e),"ERROR",{status:a.status,statusText:a.statusText}),new Error("Failed to fetch ".concat(e," ").concat(a.statusText));return[4,a.json()];case 3:return d=n.sent(),l("Individual sync successful for ".concat(e),"INFO",{dataSize:JSON.stringify(d).length}),r(o.action(d)),[2,d];case 4:return p=p.filter((function(r){return r!==e})),l("Completed individual sync for ".concat(e),"DEBUG"),[7];case 5:return[2]}}))}))};module.exports=r})();