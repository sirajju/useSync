(()=>{"use strict";var e={d:(r,t)=>{for(var n in t)e.o(t,n)&&!e.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:t[n]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},r={};e.r(r),e.d(r,{clearCache:()=>E,syncIndividual:()=>p,useSync:()=>y});const t=require("tslib"),n=require("react"),o=require("react-redux");var c,a,i=[],u=new Map;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR"}(c||(c={}));var s,f=function(e){if(a&&a.throwError)throw new Error(e);console.error(e)},d={DEBUG:"color: #5bc0de",INFO:"color: #28a745",WARN:"color: #ffc107",ERROR:"color: #dc3545",DEFAULT:""},l=function(e,r,t){if(void 0===r&&(r="INFO"),(null==a?void 0:a.log)&&function(e){if(!(null==a?void 0:a.logLevel))return!0;var r=c[a.logLevel];return c[e]>=r}(r)){var n=(new Date).toISOString(),o="[".concat(n,"] %c").concat(r.toUpperCase(),"%c: ").concat(e);if(a.logger)return a.logger(o);t?console[r.toLowerCase()](o,d[r],d.DEFAULT,t):console[r.toLowerCase()](o,d[r],d.DEFAULT)}},v=new Map,g=new Map,h=5e3,E=function(e){e?v.delete(e):v.clear()},y=function(e){var r=e.fetchOrder,c=e.fetchItems,d=e.throwError,y=void 0===d||d,_=e.cacheDuration,w=e.logLevel,R=void 0===w?"DEBUG":w,k=(0,t.__rest)(e,["fetchOrder","fetchItems","throwError","cacheDuration","logLevel"]),O=((0,n.useRef)(!0),(0,n.useRef)(!1)),m=(0,n.useRef)((0,t.__assign)({fetchOrder:r,fetchItems:c,throwError:y,logLevel:R},k));h=_||h,a=m.current,u=m.current.fetchItems,i=m.current.fetchOrder;var D=(0,t.__read)((0,n.useState)({isPending:!0,haveError:!1}),2),b=D[0],U=D[1],S=(0,t.__read)((0,n.useState)(new Set),2),I=S[0],L=S[1];(0,n.useEffect)((function(){U((function(e){return(0,t.__assign)((0,t.__assign)({},e),{isPending:I.size>0})}))}),[I]);var A=(0,n.useRef)([]),B=(0,o.useDispatch)();s=B;var G=(0,n.useCallback)((function(e){return(0,t.__awaiter)(void 0,void 0,void 0,(function(){return(0,t.__generator)(this,(function(r){switch(r.label){case 0:return[4,p(e,B)];case 1:return r.sent(),[2]}}))}))}),[B]),F=(0,n.useCallback)((function(e,r){return(0,t.__awaiter)(void 0,void 0,void 0,(function(){var n,o,c,a,i;return(0,t.__generator)(this,(function(u){L((function(r){return new Set((0,t.__spreadArray)((0,t.__spreadArray)([],(0,t.__read)(r),!1),[e.key],!1))}));try{return n="".concat(e.key,"-").concat(r),o=Date.now(),(c=v.get(n))&&o<c.expiresAt?(l("Using cached data for ".concat(e.key),"DEBUG"),[2,c.data]):(a=g.get(n))&&o-a.timestamp<5e3?(l("Reusing pending request for ".concat(e.key),"DEBUG"),[2,a.promise]):(i=(0,t.__awaiter)(void 0,void 0,void 0,(function(){var c,a;return(0,t.__generator)(this,(function(t){switch(t.label){case 0:return t.trys.push([0,,3,4]),l("Making fresh request for ".concat(e.key),"DEBUG"),[4,fetch(r,e.options||{})];case 1:if(!(c=t.sent()).ok)throw l("Request failed for ".concat(e.key),"ERROR",{status:c.status}),new Error("Failed to fetch ".concat(e.key));return[4,c.json()];case 2:return a=t.sent(),v.set(n,{data:a,timestamp:o,expiresAt:o+h}),l("Cached new data for ".concat(e.key),"DEBUG",{expiresAt:new Date(o+h)}),[2,a];case 3:return g.delete(n),[7];case 4:return[2]}}))})),g.set(n,{timestamp:o,promise:i}),[2,i])}finally{L((function(r){var t=new Set(r);return t.delete(e.key),t}))}return[2]}))}))}),[]),C=(0,n.useCallback)((function(){return(0,t.__awaiter)(void 0,void 0,void 0,(function(){var e,r,n,o,c,a,i,u,s,d;return(0,t.__generator)(this,(function(v){switch(v.label){case 0:if(!O.current)return[2];v.label=1;case 1:return v.trys.push([1,3,,4]),U({isPending:!0,haveError:!1}),l("Starting sync process","INFO"),e=[],r=[],n=[],o=m.current.fetchOrder,c=m.current.fetchItems,o.forEach((function(t){t.refetchOnline&&e.push(t.key),t.refetchOnFocus&&r.push(t.key),t.triggerEvents&&n.push({events:"string"==typeof t.triggerEvents?[t.triggerEvents]:t.triggerEvents,key:t.key})})),a=function(){l("Online event triggered","DEBUG"),e.forEach((function(e){return G(e)}))},i=function(){l("Focus event triggered","DEBUG"),r.forEach((function(e){return G(e)}))},window.addEventListener("online",a),window.addEventListener("focus",i),u=new Map,n.forEach((function(e){var r=e.key;e.events.forEach((function(e){var t=function(){l('Window event "'.concat(e,'" triggered for ').concat(r),"DEBUG"),G(r)};u.set("".concat(r,"-").concat(e),t),"undefined"!=typeof window&&window.addEventListener(e,t)}))})),s=o.map((function(e){return(0,t.__awaiter)(void 0,void 0,void 0,(function(){var r,n;return(0,t.__generator)(this,(function(o){switch(o.label){case 0:if(A.current.includes(e.key))return l("Skipping ".concat(e.key," - already pending"),"WARN"),[2];if(!(r=c.get(e.key)))return l("URL not found for ".concat(e.key),"ERROR"),[2,f("url not found for ".concat(e.key))];A.current=(0,t.__spreadArray)((0,t.__spreadArray)([],(0,t.__read)(A.current),!1),[e.key],!1),o.label=1;case 1:return o.trys.push([1,,3,4]),[4,F(e,r)];case 2:return n=o.sent(),O.current&&B(e.action(n)),[3,4];case 3:return O.current&&(A.current=A.current.filter((function(r){return r!==e.key}))),[7];case 4:return[2]}}))}))})),[4,Promise.all(s)];case 2:return v.sent(),O.current&&U({isPending:!1,haveError:!1}),[2,function(){l("Cleaning up event listeners","DEBUG"),window.removeEventListener("online",a),window.removeEventListener("focus",i),n.forEach((function(e){var r=e.key;e.events.forEach((function(e){var t=u.get("".concat(r,"-").concat(e));t&&"undefined"!=typeof window&&window.removeEventListener(e,t)}))})),u.clear()}];case 3:return d=v.sent(),U((function(e){return(0,t.__assign)((0,t.__assign)({},e),{haveError:!0})})),l("Sync process failed","ERROR",{error:d}),m.current.onError&&m.current.onError(d),[3,4];case 4:return[2]}}))}))}),[B,F,G]);return(0,n.useEffect)((function(){O.current=!0;var e=C();return function(){O.current=!1,e.then((function(e){return e&&e()}))}}),[C]),{isPending:b.isPending||I.size>0,haveError:b.haveError,clearCache:E,refresh:C,loadingItems:Array.from(I)}},_=[],p=function(e){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];return(0,t.__awaiter)(void 0,(0,t.__spreadArray)([e],(0,t.__read)(r),!1),void 0,(function(e,r){var n,o,c,a,d;return void 0===r&&(r=s),(0,t.__generator)(this,(function(t){switch(t.label){case 0:if(n="individual-".concat(e),g.get(n))return l("Request already pending for ".concat(e),"DEBUG"),[2];if(_.includes(e))return l("Skipping duplicate fetch for ".concat(e),"DEBUG"),[2];l("Starting individual sync for ".concat(e),"INFO"),_.push(e),t.label=1;case 1:return t.trys.push([1,,4,5]),o=i.find((function(r){return r.key===e})),(c=u.get(e))&&o?[4,fetch(c,o.options||{})]:(l("Configuration not found for ".concat(e),"ERROR"),[2,f("no url found for item ".concat(e))]);case 2:if(!(a=t.sent()).ok)throw l("Individual sync failed for ".concat(e),"ERROR",{status:a.status,statusText:a.statusText}),new Error("Failed to fetch ".concat(e," ").concat(a.statusText));return[4,a.json()];case 3:return d=t.sent(),l("Individual sync successful for ".concat(e),"INFO",{dataSize:JSON.stringify(d).length}),r(o.action(d)),[2,d];case 4:return _=_.filter((function(r){return r!==e})),l("Completed individual sync for ".concat(e),"DEBUG"),[7];case 5:return[2]}}))}))};module.exports=r})();