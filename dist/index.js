(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{clearCache:()=>x,getHistory:()=>I,syncIndividual:()=>U,useSync:()=>A});const n=require("react"),r=require("react-redux");var o;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR"}(o||(o={}));var a,c,i={DEBUG:"color: #5bc0de",INFO:"color: #28a745",WARN:"color: #ffc107",ERROR:"color: #dc3545",DEFAULT:""},u=function(){return u=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},u.apply(this,arguments)},s=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function c(e){try{u(r.next(e))}catch(e){a(e)}}function i(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,i)}u((r=r.apply(e,t||[])).next())}))},l=function(e,t){var n,r,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},f=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n},d=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},p=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,a=n.call(e),c=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)c.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(o)throw o.error}}return c},h=function(e,t,n){if(n||2===arguments.length)for(var r,o=0,a=t.length;o<a;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))},v=[],y=new Map,w=!1,g=[],m=5e3,E=new Map,b=new Map,O=new Map,S=[],R=function(e){if(null==a?void 0:a.throwError)throw new Error(e);console.error(e)},k=function(e,t,n){if(void 0===t&&(t="INFO"),(null==a?void 0:a.log)&&function(e){if(!(null==a?void 0:a.logLevel))return!0;var t=o[a.logLevel];return o[e]>=t}(t)){var r=(new Date).toISOString(),c="[".concat(r,"] %c").concat(t.toUpperCase(),"%c: ").concat(e);if(a.logger)return a.logger(t,e);n?console[t.toLowerCase()](c,i[t],i.DEFAULT,n):console[t.toLowerCase()](c,i[t],i.DEFAULT)}},D=function(e,t){var n,r;if(!t||0===Object.keys(t).length)return e;var o=new URLSearchParams;try{for(var a=d(Object.entries(t)),c=a.next();!c.done;c=a.next()){var i=p(c.value,2),u=i[0],s=i[1];null!=s&&o.append(u,String(s))}}catch(e){n={error:e}}finally{try{c&&!c.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}var l=o.toString();return l?"".concat(e).concat(e.includes("?")?"&":"?").concat(l):e},P=function(e,t){var n=S.findIndex((function(t){return t.url===e.url&&t.timestamp===e.timestamp}));-1!==n&&(S[n]=u(u({},S[n]),{recieveTime:Date.now(),response:t}))},x=function(e){e?E.delete(e):E.clear()},I=function(e){return void 0===e&&(e=!0),e&&function(e){void 0===e&&(e=3e5);var t=Date.now();S=S.filter((function(n){return t-n.timestamp<e}))}(),S},U=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return s(void 0,h([e],p(t),!1),void 0,(function(e,t,n,r){var o,i,f,d,p,h,m,E,b;return void 0===t&&(t={}),void 0===r&&(r=c),l(this,(function(c){switch(c.label){case 0:return w||!a.waiting?[3,2]:(k("".concat(e," Waiting for initial sync to complete"),"DEBUG"),[4,s(void 0,void 0,void 0,(function(){return l(this,(function(e){return[2,new Promise((function(e){var t=setInterval((function(){w&&(clearInterval(t),e(!0))}),100)}))]}))}))]);case 1:c.sent(),c.label=2;case 2:if(o=v.find((function(t){return t.key===e})),!(i=y.get(e))||!o)return k("Configuration not found for ".concat(e),"ERROR"),[2,R("no url found for item ".concat(e))];if(!o.allowDuplicates){if(g.includes("".concat(e,"_").concat(t.path)))return k("Skipping duplicate fetch for ".concat(e),"DEBUG"),[2];k("Starting individual sync for ".concat(e),"INFO"),g.push("".concat(e,"_").concat(t.path))}c.label=3;case 3:return c.trys.push([3,9,10,11]),f=u(u({},o.options),t),d=f.path?"".concat(i).concat(f.path):i,p=f.params?D(d,f.params):d,h={url:p,timestamp:Date.now(),params:f.params||{},headers:f.headers||{},options:f,path:f.path||"",response:void 0,recieveTime:void 0},S.push(h),[4,fetch(p,f)];case 4:if(!(m=c.sent()).ok)throw k("Sync failed for ".concat(e),"ERROR",{status:m.status,statusText:m.statusText}),new Error("Failed to fetch ".concat(e," ").concat(m.statusText));return E=null,o.transformResponse?[3,6]:[4,m.json()];case 5:return E=c.sent(),[3,8];case 6:return[4,o.transformResponse(m)];case 7:E=c.sent(),c.label=8;case 8:return P(h,E),k("Individual sync successful for ".concat(e),"INFO",{dataSize:JSON.stringify(E).length}),r("function"==typeof n?n(E):o.action(E)),[2,E];case 9:return b=c.sent(),k("Sync error : ".concat(b),"ERROR"),[3,11];case 10:return g=g.filter((function(n){return n!=="".concat(e,"_").concat(t.path)})),k("Completed individual sync for ".concat(e),"DEBUG"),[7];case 11:return[2]}}))}))},A=function(e){var t=e.fetchOrder,o=e.fetchItems,i=e.throwError,g=void 0===i||i,I=e.cacheDuration,A=e.logLevel,L=void 0===A?"DEBUG":A,j=f(e,["fetchOrder","fetchItems","throwError","cacheDuration","logLevel"]);t=t.sort((function(e,t){return t.priority-e.priority}));var N=(0,n.useRef)(!1),B=(0,n.useRef)(u({fetchOrder:t,fetchItems:o,throwError:g,logLevel:L},j));m=I||m,a=B.current,y=B.current.fetchItems,v=B.current.fetchOrder;var F=p((0,n.useState)({isPending:!0,haveError:!1}),2),G=F[0],T=F[1],C=p((0,n.useState)(new Set),2),M=C[0],W=C[1];(0,n.useEffect)((function(){T((function(e){return u(u({},e),{isPending:M.size>0})})),w=0==M.size}),[M]);var _=(0,n.useRef)([]),q=(0,r.useDispatch)();c=q;var z=(0,n.useCallback)((function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return s(void 0,h([e],p(t),!1),void 0,(function(e,t){return void 0===t&&(t={}),l(this,(function(n){switch(n.label){case 0:return[4,U(e,t,null,q)];case 1:return n.sent(),[2]}}))}))}),[q]),H=(0,n.useCallback)((function(e,t){return s(void 0,void 0,void 0,(function(){var n,r,o,c,i;return l(this,(function(u){W((function(t){return new Set(h(h([],p(Array.from(t)),!1),[e.key],!1))}));try{return n="".concat(e.key,"-").concat(t),r=Date.now(),(o=E.get(n))&&r<o.expiresAt?(k("Using cached data for ".concat(e.key),"DEBUG"),[2,o.data]):(c=b.get(n))&&r-c.timestamp<5e3?(k("Reusing pending request for ".concat(e.key),"DEBUG"),[2,c.promise]):(i=s(void 0,void 0,void 0,(function(){var o,c,i,u,s,f,d,p,h,v,y,w;return l(this,(function(l){switch(l.label){case 0:return l.trys.push([0,,9,10]),k("Making fresh request for ".concat(e.key),"DEBUG"),o=null===(p=e.options)||void 0===p?void 0:p.params,c=(null===(h=e.options)||void 0===h?void 0:h.path)?"".concat(t).concat(null===(v=e.options)||void 0===v?void 0:v.path):t,i=o?D(c,o):c,u={url:i||t,timestamp:Date.now(),params:o||{},headers:(null===(y=e.options)||void 0===y?void 0:y.headers)||{},options:e.options||{},path:(null===(w=e.options)||void 0===w?void 0:w.path)||"",response:void 0,recieveTime:void 0},S.push(u),a.customFetch?[4,a.customFetch(i,e.options||{})]:[3,2];case 1:return f=l.sent(),[3,4];case 2:return[4,fetch(i,e.options||{})];case 3:f=l.sent(),l.label=4;case 4:return s=f,d=null,e.transformResponse?[3,6]:[4,s.json()];case 5:return d=l.sent(),[3,8];case 6:return[4,e.transformResponse(s)];case 7:d=l.sent(),l.label=8;case 8:if(P(u,d),!s.ok)try{k(d.message||"Request failed for ".concat(e.key),"ERROR",{status:s.status,statusText:s.statusText}),P(u,d),R(d.message||s)}catch(e){R(d.message||s)}return E.set(n,{data:d,timestamp:r,expiresAt:r+m}),k("Cached new data for ".concat(e.key),"DEBUG",{expiresAt:new Date(r+m)}),[2,d];case 9:return b.delete(n),[7];case 10:return[2]}}))})),b.set(n,{timestamp:r,promise:i}),[2,i])}finally{}return[2]}))}))}),[]),J=(0,n.useCallback)((function(){return s(void 0,void 0,void 0,(function(){var e,t,n,r,o,c,i,f,v,y,g,m,E,b,S,D,P;return l(this,(function(x){switch(x.label){case 0:if(w=!1,!N.current)return[2];x.label=1;case 1:return x.trys.push([1,3,4,5]),T({isPending:!0,haveError:!1}),k("Starting sync process","INFO"),e=[],t=[],n=[],r=B.current.fetchOrder,o=B.current.fetchItems,r.forEach((function(r){r.refetchOnline&&e.push(r.key),r.refetchOnFocus&&t.push(r.key),r.triggerEvents&&n.push({events:"string"==typeof r.triggerEvents?[r.triggerEvents]:r.triggerEvents,key:r.key})})),c=function(){k("Online event triggered","DEBUG"),e.forEach((function(e){return z(e)}))},i=function(){k("Focus event triggered","DEBUG"),t.forEach((function(e){return z(e)}))},window.addEventListener("online",c),window.addEventListener("focus",i),f=new Map,n.forEach((function(e){var t=e.key;e.events.forEach((function(e){var n=function(){k('Window event "'.concat(e,'" triggered for ').concat(t),"DEBUG"),z(t)};f.set("".concat(t,"-").concat(e),n),"undefined"!=typeof window&&window.addEventListener(e,n)}))})),v=r.map((function(e){return s(void 0,void 0,void 0,(function(){var t,n,r,c,i,u;return l(this,(function(s){switch(s.label){case 0:if(t=o.get(e.key),"object"==typeof e.includedPaths&&Array.isArray(e.includedPaths)&&(n=a.getPathName?a.getPathName(t):window.location.pathname,!e.includedPaths.includes(n)))return k("Skipping ".concat(e.key," - not in included paths"),"WARN"),[2];if("object"==typeof e.excludedPaths&&Array.isArray(e.excludedPaths)&&(n=a.getPathName?a.getPathName(t):window.location.pathname,e.excludedPaths.includes(n)))return k("Skipping ".concat(e.key," - in excluded paths"),"WARN"),[2];if("boolean"==typeof e.initialSync&&!e.initialSync)return[2];if("boolean"==typeof e.backgroundSync&&e.backgroundSync)return W((function(t){var n=new Set(t);return n.delete(e.key),n})),[2,O.set(e.key,(function(){return z(e.key)}))];if(_.current.includes("".concat(e.key,"_").concat(null===(i=e.options)||void 0===i?void 0:i.path)))return k("Skipping ".concat(e.key," - already pending"),"WARN"),[2];if(!t)return k("URL not found for ".concat(e.key),"ERROR"),[2,R("url not found for ".concat(e.key))];_.current=h(h([],p(_.current),!1),["".concat(e.key,"_").concat(null===(u=e.options)||void 0===u?void 0:u.path)],!1),s.label=1;case 1:return s.trys.push([1,3,4,5]),[4,H(e,t)];case 2:return r=s.sent(),W((function(t){var n=new Set(t);return n.delete(e.key),n})),N.current&&q(e.action(r)),[3,5];case 3:return c=s.sent(),k("Sync error : ".concat(c),"ERROR"),[3,5];case 4:return N.current&&(_.current=_.current.filter((function(t){var n;return t!=="".concat(e.key,"_").concat(null===(n=e.options)||void 0===n?void 0:n.path)}))),[7];case 5:return[2]}}))}))})).filter(Boolean),[4,Promise.all(v)];case 2:if(x.sent(),N.current){T({isPending:!1,haveError:!1}),y=Array.from(O.entries());try{for(g=d(y),m=g.next();!m.done;m=g.next())E=p(m.value,2),b=E[0],(0,E[1])(),O.delete(b)}catch(e){D={error:e}}finally{try{m&&!m.done&&(P=g.return)&&P.call(g)}finally{if(D)throw D.error}}}return[2,function(){k("Cleaning up event listeners","DEBUG"),window.removeEventListener("online",c),window.removeEventListener("focus",i),n.forEach((function(e){var t=e.key;e.events.forEach((function(e){var n=f.get("".concat(t,"-").concat(e));n&&"undefined"!=typeof window&&window.removeEventListener(e,n)}))})),f.clear()}];case 3:return S=x.sent(),T((function(e){return u(u({},e),{haveError:!0})})),w=!0,k("Sync process failed","ERROR",{error:S}),B.current.onError&&B.current.onError(S),[3,5];case 4:return[7];case 5:return[2]}}))}))}),[q,H,z]),K=p((0,n.useState)(window.location.pathname),2),Q=K[0],V=K[1];return(0,n.useEffect)((function(){if(B.current.reSyncOnPathChange){var e=function(){var e=window.location.pathname;e!==Q&&(V(e),k("Location changed, triggering re-sync","INFO"),J())};window.addEventListener("popstate",e);var t=window.history.pushState,n=window.history.replaceState;return window.history.pushState=function(){t.apply(this,h([],p(arguments),!1)),e()},window.history.replaceState=function(){n.apply(this,h([],p(arguments),!1)),e()},function(){window.removeEventListener("popstate",e),window.history.pushState=t,window.history.replaceState=n}}}),[Q,J]),(0,n.useEffect)((function(){N.current=!0;var e=J();return function(){N.current=!1,e.then((function(e){return e&&e()}))}}),[J]),{isPending:G.isPending||M.size>0,haveError:G.haveError,clearCache:x,refresh:J,loadingItems:Array.from(M)}};module.exports=t})();