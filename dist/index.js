(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{clearCache:()=>k,syncIndividual:()=>x,useSync:()=>D});const n=require("react"),r=require("react-redux");var o,c,a=function(){return a=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},a.apply(this,arguments)},i=function(e,t,n,r){return new(n||(n=Promise))((function(o,c){function a(e){try{u(r.next(e))}catch(e){c(e)}}function i(e){try{u(r.throw(e))}catch(e){c(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}u((r=r.apply(e,t||[])).next())}))},u=function(e,t){var n,r,o,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=i(0),a.throw=i(1),a.return=i(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,i[0]&&(c=0)),c;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,r=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(o=c.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){c=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){c.label=i[1];break}if(6===i[0]&&c.label<o[1]){c.label=o[1],o=i;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(i);break}o[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},s=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n},l=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},f=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,c=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=c.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=c.return)&&n.call(c)}finally{if(o)throw o.error}}return a},d=function(e,t,n){if(n||2===arguments.length)for(var r,o=0,c=t.length;o<c;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))},v=[],y=new Map;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR"}(o||(o={}));var p,h=function(e){if(c&&c.throwError)throw new Error(e);console.error(e)},g={DEBUG:"color: #5bc0de",INFO:"color: #28a745",WARN:"color: #ffc107",ERROR:"color: #dc3545",DEFAULT:""},w=function(e,t,n){if(void 0===t&&(t="INFO"),(null==c?void 0:c.log)&&function(e){if(!(null==c?void 0:c.logLevel))return!0;var t=o[c.logLevel];return o[e]>=t}(t)){var r=(new Date).toISOString(),a="[".concat(r,"] %c").concat(t.toUpperCase(),"%c: ").concat(e);if(c.logger)return c.logger(t,e);n?console[t.toLowerCase()](a,g[t],g.DEFAULT,n):console[t.toLowerCase()](a,g[t],g.DEFAULT)}},E=new Map,b=new Map,m=new Map,O=5e3,k=function(e){e?E.delete(e):E.clear()},R=function(e,t){var n,r;if(!t||0===Object.keys(t).length)return e;var o=new URLSearchParams;try{for(var c=l(Object.entries(t)),a=c.next();!a.done;a=c.next()){var i=f(a.value,2),u=i[0],s=i[1];null!=s&&o.append(u,String(s))}}catch(e){n={error:e}}finally{try{a&&!a.done&&(r=c.return)&&r.call(c)}finally{if(n)throw n.error}}var d=o.toString();return d?"".concat(e).concat(e.includes("?")?"&":"?").concat(d):e},S=!1,D=function(e){var t=e.fetchOrder,o=e.fetchItems,g=e.throwError,D=void 0===g||g,U=e.cacheDuration,I=e.logLevel,P=void 0===I?"DEBUG":I,j=s(e,["fetchOrder","fetchItems","throwError","cacheDuration","logLevel"]);t=t.sort((function(e,t){return t.priority-e.priority}));var A=(0,n.useRef)(!1),L=(0,n.useRef)(a({fetchOrder:t,fetchItems:o,throwError:D,logLevel:P},j));O=U||O,c=L.current,y=L.current.fetchItems,v=L.current.fetchOrder;var B=f((0,n.useState)({isPending:!0,haveError:!1}),2),G=B[0],F=B[1],N=f((0,n.useState)(new Set),2),C=N[0],T=N[1];(0,n.useEffect)((function(){F((function(e){return a(a({},e),{isPending:C.size>0})})),S=0==C.size}),[C]);var M=(0,n.useRef)([]),_=(0,r.useDispatch)();p=_;var W=(0,n.useCallback)((function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return i(void 0,d([e],f(t),!1),void 0,(function(e,t){return void 0===t&&(t={}),u(this,(function(n){switch(n.label){case 0:return[4,x(e,t,null,_)];case 1:return n.sent(),[2]}}))}))}),[_]),q=(0,n.useCallback)((function(e,t){return i(void 0,void 0,void 0,(function(){var n,r,o,c,a;return u(this,(function(s){T((function(t){return new Set(d(d([],f(Array.from(t)),!1),[e.key],!1))}));try{return n="".concat(e.key,"-").concat(t),r=Date.now(),(o=E.get(n))&&r<o.expiresAt?(w("Using cached data for ".concat(e.key),"DEBUG"),[2,o.data]):(c=b.get(n))&&r-c.timestamp<5e3?(w("Reusing pending request for ".concat(e.key),"DEBUG"),[2,c.promise]):(a=i(void 0,void 0,void 0,(function(){var o,c,a,i,s;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,,3,4]),w("Making fresh request for ".concat(e.key),"DEBUG"),o=null===(s=e.options)||void 0===s?void 0:s.params,c=o?R(t,o):t,[4,fetch(c,e.options||{})];case 1:if(!(a=u.sent()).ok)throw w("Request failed for ".concat(e.key),"ERROR",{status:a.status}),new Error("Failed to fetch ".concat(e.key));return[4,a.json()];case 2:return i=u.sent(),E.set(n,{data:i,timestamp:r,expiresAt:r+O}),w("Cached new data for ".concat(e.key),"DEBUG",{expiresAt:new Date(r+O)}),[2,i];case 3:return b.delete(n),[7];case 4:return[2]}}))})),b.set(n,{timestamp:r,promise:a}),[2,a])}finally{}return[2]}))}))}),[]),z=(0,n.useCallback)((function(){return i(void 0,void 0,void 0,(function(){var e,t,n,r,o,c,s,v,y,p,g,E,b,O,k,R,D;return u(this,(function(U){switch(U.label){case 0:if(S=!1,!A.current)return[2];U.label=1;case 1:return U.trys.push([1,3,4,5]),F({isPending:!0,haveError:!1}),w("Starting sync process","INFO"),e=[],t=[],n=[],r=L.current.fetchOrder,o=L.current.fetchItems,r.forEach((function(r){r.refetchOnline&&e.push(r.key),r.refetchOnFocus&&t.push(r.key),r.triggerEvents&&n.push({events:"string"==typeof r.triggerEvents?[r.triggerEvents]:r.triggerEvents,key:r.key})})),c=function(){w("Online event triggered","DEBUG"),e.forEach((function(e){return W(e)}))},s=function(){w("Focus event triggered","DEBUG"),t.forEach((function(e){return W(e)}))},window.addEventListener("online",c),window.addEventListener("focus",s),v=new Map,n.forEach((function(e){var t=e.key;e.events.forEach((function(e){var n=function(){w('Window event "'.concat(e,'" triggered for ').concat(t),"DEBUG"),W(t)};v.set("".concat(t,"-").concat(e),n),"undefined"!=typeof window&&window.addEventListener(e,n)}))})),y=r.map((function(e){return i(void 0,void 0,void 0,(function(){var t,n,r,c,a;return u(this,(function(i){switch(i.label){case 0:if("object"==typeof e.includedPaths&&Array.isArray(e.includedPaths)&&(t=window.location.pathname,!e.includedPaths.includes(t)))return w("Skipping ".concat(e.key," - not in included paths"),"WARN"),[2];if("boolean"==typeof e.initialSync&&!e.initialSync)return[2];if("boolean"==typeof e.backgroundSync&&e.backgroundSync)return T((function(t){var n=new Set(t);return n.delete(e.key),n})),[2,m.set(e.key,(function(){return W(e.key)}))];if(M.current.includes("".concat(e.key,"_").concat(null===(c=e.options)||void 0===c?void 0:c.path)))return w("Skipping ".concat(e.key," - already pending"),"WARN"),[2];if(!(n=o.get(e.key)))return w("URL not found for ".concat(e.key),"ERROR"),[2,h("url not found for ".concat(e.key))];M.current=d(d([],f(M.current),!1),["".concat(e.key,"_").concat(null===(a=e.options)||void 0===a?void 0:a.path)],!1),i.label=1;case 1:return i.trys.push([1,,3,4]),[4,q(e,n)];case 2:return r=i.sent(),T((function(t){var n=new Set(t);return n.delete(e.key),n})),A.current&&_(e.action(r)),[3,4];case 3:return A.current&&(M.current=M.current.filter((function(t){var n;return t!=="".concat(e.key,"_").concat(null===(n=e.options)||void 0===n?void 0:n.path)}))),[7];case 4:return[2]}}))}))})).filter(Boolean),[4,Promise.all(y)];case 2:if(U.sent(),A.current){F({isPending:!1,haveError:!1}),p=Array.from(m.entries());try{for(g=l(p),E=g.next();!E.done;E=g.next())b=f(E.value,2),O=b[0],(0,b[1])(),m.delete(O)}catch(e){R={error:e}}finally{try{E&&!E.done&&(D=g.return)&&D.call(g)}finally{if(R)throw R.error}}}return[2,function(){w("Cleaning up event listeners","DEBUG"),window.removeEventListener("online",c),window.removeEventListener("focus",s),n.forEach((function(e){var t=e.key;e.events.forEach((function(e){var n=v.get("".concat(t,"-").concat(e));n&&"undefined"!=typeof window&&window.removeEventListener(e,n)}))})),v.clear()}];case 3:return k=U.sent(),F((function(e){return a(a({},e),{haveError:!0})})),S=!0,w("Sync process failed","ERROR",{error:k}),L.current.onError&&L.current.onError(k),[3,5];case 4:return[7];case 5:return[2]}}))}))}),[_,q,W]);return(0,n.useEffect)((function(){A.current=!0;var e=z();return function(){A.current=!1,e.then((function(e){return e&&e()}))}}),[z]),{isPending:G.isPending||C.size>0,haveError:G.haveError,clearCache:k,refresh:z,loadingItems:Array.from(C)}},U=[],x=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return i(void 0,d([e],f(t),!1),void 0,(function(e,t,n,r){var o,s,l,f,d,g,E,m,O;return void 0===t&&(t={}),void 0===r&&(r=p),u(this,(function(p){switch(p.label){case 0:return S||!c.waiting?[3,2]:(w("".concat(e," Waiting for initial sync to complete"),"DEBUG"),[4,i(void 0,void 0,void 0,(function(){return u(this,(function(e){return[2,new Promise((function(e){var t=setInterval((function(){S&&(clearInterval(t),e(!0))}),100)}))]}))}))]);case 1:p.sent(),p.label=2;case 2:if(o="individual-".concat(e),b.get(o))return w("Request already pending for ".concat(e),"DEBUG"),[2];if(U.includes("".concat(e,"_").concat(t.path)))return w("Skipping duplicate fetch for ".concat(e),"DEBUG"),[2];w("Starting individual sync for ".concat(e),"INFO"),U.push("".concat(e,"_").concat(t.path)),p.label=3;case 3:return p.trys.push([3,9,10,11]),s=v.find((function(t){return t.key===e})),(l=y.get(e))&&s?(f=a(a({},s.options),t),d=f.path?"".concat(l).concat(f.path):l,g=f.params?R(d,f.params):d,[4,fetch(g,f)]):(w("Configuration not found for ".concat(e),"ERROR"),[2,h("no url found for item ".concat(e))]);case 4:if(!(E=p.sent()).ok)throw w("Sync failed for ".concat(e),"ERROR",{status:E.status,statusText:E.statusText}),new Error("Failed to fetch ".concat(e," ").concat(E.statusText));return m=null,s.transformResponse?[3,6]:[4,E.json()];case 5:return m=p.sent(),[3,8];case 6:return[4,s.transformResponse(E)];case 7:m=p.sent(),p.label=8;case 8:return w("Individual sync successful for ".concat(e),"INFO",{dataSize:JSON.stringify(m).length}),r("function"==typeof n?n(m):s.action(m)),[2,m];case 9:return O=p.sent(),w("Sync error : ".concat(O),"ERROR"),[3,11];case 10:return U=U.filter((function(n){return n!=="".concat(e,"_").concat(t.path)})),w("Completed individual sync for ".concat(e),"DEBUG"),[7];case 11:return[2]}}))}))};module.exports=t})();